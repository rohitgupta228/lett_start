!function ($) {
  var Download = function () {
  }
  Download.prototype.getList = function () {
    if ($.API) {
      var self = this;
      var prom = $.API.get('user/order-history');
      prom.then(function (data) {
        Download.prototype.downloadList = data;
        self.generateHTML(data);
      }).catch(function (error) {
        console.log("generic api failed message")
      }).finally(function () {

      })
    }
  }
  Download.prototype.generateHTML = function (resp) {
    $("#themes-list").html("");
    resp.forEach(function (elem) {
      var img = elem.screenshot.split(".")[0];
      var type = elem.screenshot.split(".")[1];
      var smImg = elem.screenshot ? img + '-sm.' + type : 'loading.jpg';
      if (elem) {
        var str = '';
        str += '<div class="col-md-6 col-xl-4">' +
          '<div class="demo-item" data-id="' + elem.id + '">' +
          '<a href="theme/' + elem.detailLink + '" class="screenshot">' +
          '<img src="assets/images/slider-screenshot/' + elem.screenshot + '" srcset="assets/images/slider-screenshot/' + smImg + ' 766w, assets/images/slider-screenshot/' + elem.screenshot + ' 3000w" alt="' + elem.name + '" class="img-fluid w-100"  width="714" height="456"/>' +
          '</a>' +
          '<div class="theme-desc">' +
          '<div class="title">' +
          '<h3 class="h5"><a href="theme/' + elem.detailLink + '" title="' + elem.name + '">' + elem.name + '</a></h3>' +
          '<p class="font-size-14">' + elem.oneLinerDesc + '</p>' +
          '</div>' +
          '<div class="price">' +
          '<h4 class="font-weight-bold">$' + elem.price + '</h4>' +
          '<button class="btn btn-sm btn-primary-gred" onclick="downloadTheme()">' +
          '<span>Download</span><span class="align-middle btn-loader"><i class="bx bx-loader-alt bx-spin icon-md"></i></span>' +
          '</button>' +
          '</div>' +
          '</div>' +
          '</div>' +
          '</div>';
        var item = $.parseHTML(str);
        $("#themes-list").append(item);
      }
    });
  }
  Download.prototype.init = function () {
    this.getList();
  }
  $.Download = new Download, $.Download.Constructor = Download
}(window.jQuery),

  //initializing App
  function ($) {
    "use strict";
    $.Download.init();
  }(window.jQuery);

function downloadTheme() {
  var id = $(event.target).parents(".demo-item").attr("data-id");
  var downloadItem = [];
  if ($.Download.downloadList && $.Download.downloadList.length) {
    downloadItem = $.Download.downloadList.filter(function (item) {
      return item.id === parseInt(id)
    })
  }
  if (downloadItem.length && window.currentuser) {
    var userId = window.currentuser.id;
    window.open("https://lettstartdesign.com/laravel-backend/api/user/download-theme/" + downloadItem[0].productId+'/'+userId, '_blank')
  }
  $(event.currentTarget).removeClass("disable-events");
}
