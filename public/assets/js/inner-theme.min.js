var priceMapper = {"1":"12","2":"12","3":"4","4":"","5":"8","6":"","7":"4","8":"8","9":"16","10":"8","11":"12","12":"12","13":"","14":"","15":"","16":"8","17":"12","18":"4"}

!function ($) {
  var PageProducts = function () {
  };
  
  //load razor pay after 5 seconds
  PageProducts.prototype.loadRazorpayScript = function () {
    setTimeout(function () {
      var script = document.createElement('script');
      script.src = "https://checkout.razorpay.com/v1/checkout.js";
      document.body.appendChild(script);
      $("#option-data #razorpay-btn").removeAttr("disabled");
    }, 5000)
  }

  //check user is authenticated or not
  PageProducts.prototype.getAuthentication = function () {
    var token = localStorage.getItem("token");
    return token && token !== "" ? true : false
  }

  //convert date
  PageProducts.prototype.getDate = function (date) {
    var monthMapper = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    var formattedDate = new Date(date);
    var day = formattedDate.getDate();
    var month = monthMapper[formattedDate.getMonth()];
    var year = formattedDate.getFullYear();
    return month + ', ' + day + ' ' + year;
  }

  //init funs
  PageProducts.prototype.init = function () {
    var pathname = window.location.pathname;
    var splitPath = pathname.split("/");
    var pagename = splitPath[splitPath.length - 1];
    var params = new URLSearchParams(window.location.search);
    var success = params.get('success');
    if (success === 'true') {
      $("#successModal").modal('show')
    }
    else if (success === 'false') {
      $("#failureModal").modal('show')
    }
    this.loadRazorpayScript();
    var self = this;
    if ($.API) {
      var prom = $.API.getWithoutToken('product/details/' + pagename);
      prom.then(function (data) {
        if (data.product) {
          var img = data.product.screenshot.split(".")[0];
          var type = data.product.screenshot.split(".")[1];
          var smImg = data.product.screenshot ? img + '-sm.' + type : 'loading.jpg';
          data.product.added = JSON.parse(data.product.added);
          data.product.category = JSON.parse(data.product.category);
          data.product.changeLog = JSON.parse(data.product.changeLog);
          data.product.created_at = self.getDate(data.product.created_at);
          data.product.updated_at = self.getDate(data.product.updated_at);
          data.product.highlight1 = JSON.parse(data.product.highlight1);
          data.product.highlight2 = JSON.parse(data.product.highlight2);
          data.product.initialLog = JSON.parse(data.product.initialLog);
          data.product.screenshots = JSON.parse(data.product.screenshots);
          data.product.techUsed = JSON.parse(data.product.techUsed);
          data.product.themeFacts = JSON.parse(data.product.themeFacts);
          data.product.free = parseInt(data.product.price) > 0 ? false : true;
          data.product.smImg = smImg;
          self.generateHTML(data.product);
          self.generateRelatedHTML(data.realtedProducts);
        }
      }).catch(function (error) {
        console.log("generic error")
      }).finally(function () {
        $("#inner-content-wrapper").find('.loader-wrap').removeClass('show');
        $("#inner-content-wrapper").find('.inner-content').removeClass('d-none');
      })
    }
  }

  //call after html loads
  PageProducts.prototype.runFn = function () {
    var self = this;
    $("#licence-types li").on("click", function () {
      $(this).addClass("selected").siblings().removeClass("selected");
      var id = $(this).attr("data-tab");
      if (id === 'multiple') {
        window.currentPck.multiple = true
      }
      if (id === 'single') {
        window.currentPck.multiple = false
      }
      $("[data-id = " + id + "]").fadeIn().siblings().hide();
    })

    $(".package-tabs .nav-link").on("click", function (e) {
      e.preventDefault();
      window.history.pushState({}, "", window.location.origin + window.location.pathname);
      var href = $(this).attr("href");
      $(href).addClass("show active").siblings().removeClass("show active");
      $(this).addClass("active").parent().siblings().find('.active').removeClass("active");
    })

    $("#preview-btn").on("click", function () {
      $("html, body").animate({
        scrollTop: $(".package-tabs").offset().top - 120
      }, 'slow');
      $("#demo-tab").trigger('click')
    })

    if (location.hash === '#demos') {
      setTimeout(function () {
        $("#preview-btn").trigger('click')
      }, 100)
    }

    //hide bootstrap modal
    $('#successModal, #failureModal').on('hide.bs.modal', function () {
      window.history.pushState({}, "", window.location.origin + window.location.pathname);
    })

    //choose payment option
    $("#options .pay-btn").on('click', function () {
      var id = $(this).attr('button-selection');
      var payType = $(this).attr('payment-type');
      $(this).addClass('selected').siblings().removeClass('selected');
      $("#option-data").find('[data-id=' + id + ']').addClass('active show').attr('payment-type', payType).siblings().removeClass('active show');
    })

    //razorpay purchase event
    $("#razorpay-btn").on('click', function () {
      if (self.getAuthentication()) {
        $(this).addClass("disable-events");
        self.purchaseEvent()
      }
      else {
        $("#loginModal").modal('show');
      }
    })

    //paypal purchase event
    $("#paypal-btn").on("click", function () {
      if ($.API) {
        var elem = this;
        var payload = {
          "product_id": window.currentPck.productId,
          "multi": window.currentPck.multiple
        }
        $(this).addClass("disable-events");
        var prom = $.API.post('payment/paypal', payload);
        prom.then(function (data) {
          if (data.status) {
            window.location.href = data.url;
            return;
          }
        }).catch(function (error) {
          $(elem).removeClass("disable-events");
          if (error && error.noToken) {
            $("#loginModal").modal('show');
            return;
          }
        })
      }
    });

    //free purchase event
    $("#free-purchase").on("click", function () {
      if ($.API) {
        var elem = this;
        var payload = {
          "product_id": window.currentPck.productId
        }
        var elem = this; 
        $(this).addClass("disable-events");
        var prom = $.API.post('payment/free', payload);
        prom.then(function (data) {
          self.downloadPackage()
        }).catch(function (error) {
          if (error && error.noToken) {
            $("#loginModal").modal('show');
            return;
          }
          $("#failureModal").modal('show');
        }).finally(function () {
          $(elem).removeClass("disable-events");
        })
      }
    });
  }

  //Razorpay buy now event
  PageProducts.prototype.purchaseEvent = function () {
    this.razorpayOrderCreate();
  }

  //Razorpay create order
  PageProducts.prototype.razorpayOrderCreate = function () {
    if ($.API) {
      var payload = {
        product_id: window.currentPck.productId,
        multi: window.currentPck.multiple
      }
      var self = this;
      $.API.post('razorpay/order/create', payload).then(function (resp) {
        if (resp) {
          var options = self.razorpayOption(resp.order_id);
          var rzpay = new Razorpay(options);
          rzpay.open();
          rzpay.on('payment.failed', function (response) {
            console.log("failed resp", response)
            throw response;
          });
        }
      }).catch(function (error) {
        console.log("create order error ==>", error);
      }).finally(function () {
        $("#razorpay-btn").removeClass("disable-events");
      })
    }
  }

  //Razorpay verify order to save data on BE
  PageProducts.prototype.razorpayOrderVerify = function (response) {
    if ($.API) {
      var self = this;
      var payload = Object.assign(response, {
        product_id: window.currentPck.productId,
        multi: window.currentPck.multiple
      })
      $.API.post('razorpay/order/verify', payload).then(function (resp) {
        if (resp && resp.code === 200 && resp.hasOwnProperty('product_name')) {
          self.downloadPackage()
        }
        else {
          $("#failureModal").modal('show');
        }
      }).catch(function (error) {

      })
    }
  }

  //download package after payment success
  PageProducts.prototype.downloadPackage = function() {
    $("#successModal").modal('show');
    if(window.currentuser){
      var userId = window.currentuser.id;
      window.open("https://lettstartdesign.com/laravel-backend/api/user/download-theme/" + window.currentPck.productId+'/'+userId, '_blank')
    }

  }

  //get razorpay option
  PageProducts.prototype.razorpayOption = function (orderId) {
    var self = this;
    var obj = {}
    if (window.currentPck) {
      obj['product_name'] = window.currentPck.name;
      obj['amount'] = window.currentPck.multiple ? window.currentPck.multiPrice : window.currentPck.price;
    }
    if (window.currentuser) {
      obj["email_address"] = window.currentuser.email;
    }
    return {  
      name: "Lettstart Design",
      description: window.currentPck.name,
      image: "https://lettstartdesign.com/assets/images/logo-dark.png",
      "order_id": orderId,
      "handler": function (response) {
        self.razorpayOrderVerify(response)
      },
      "notes": obj,
      "theme": {
        "color": "#2982de"
      }
    }
  }

  //generate highlights html
  PageProducts.prototype.generateHighlights = function(container, data) {
    var highlight = data.map(function (item) {
      var str = '<ul class="list-unstyled">'
      str += '<li><i class="bx bxs-check-circle text-success h5 mb-0 mr-2 font-weight-normal"></i> <span>' + item + '</span></li>';
      str += '</ul>';
      return str
    })
    $(container).html(highlight.join(""));
  }

  //generate theme fact html
  PageProducts.prototype.generateThemeFact = function (container, themeFacts) {
    var keys = Object.keys(themeFacts);
    themeFacts = keys.map(function (key) {
      var str = '<div class="facts text-center">';
      themeFacts[key].forEach(function (item) {
        str += '<div class="card box-shadow-none">'
        str += '<div class="card-body">'
        str += '<h3 class="card-title h2">' + item.title + '</h3>'
        str += '<p class="card-text mb-0">' + item.text + '</p>'
        str += '</div>'
        str += '</div>'
      })
      str += '</div>';
      return str
    })
    $(container).html(themeFacts.join(""));
  }

  //generate screenshots
  PageProducts.prototype.generateScreenshots = function (container, data){
    var product = data.screenshots.map(function (item) {
      var str = '<div class="theme-demos mb-3">';
      str += '<div class="head-text">';
      str += '<h2 class="h3">' + item.title + '</h2>';
      str += '</div>';
      str += '<div class="demo-screenshot">';
      str += '<div class="row gutter-size-25">';
      var screens = item.screens.map(function (innerItem) {
        var innerstr = '<div class="col-md-6 col-lg-4">';
        innerstr += '<div class="demo-theme-item">';
        innerstr += '<a href="' + data.liveDemoBaseStr + '' + innerItem.link + '" target="_blank">';
        innerstr += '<img src="../assets/images/screenshots/' + data.screenshotDir + '/' + innerItem.img + '" class="img-fluid border-radius-1x" alt="index" />';
        innerstr += '</a>';
        innerstr += '<div class="desc">';
        innerstr += '<h5>' + innerItem.imgTitle + '</h5>';
        innerstr += '<a href="' + data.liveDemoBaseStr + '' + innerItem.link + '" target="_blank">Live Preview</a>';
        innerstr += '</div>';
        innerstr += '</div>';
        innerstr += '</div>';
        return innerstr
      })
      str += screens.join("");
      str += '</div>';
      str += '</div>';
      str += '</div>';
      str += '</div>';
      return str
    })
    var themefactHTML = $("#demos .theme-facts").clone();
    $(container).html(product.join(""));
    $(container).append(themefactHTML);
  }

  //generate initial logs
  PageProducts.prototype.generateInitialLog = function(container, data) {
    var logs = data.initialLog.map(function (item) {
      var str = '<div class="logs">'
      str += '<span class="bx '+ item.icon+' text-primary mr-1"></span>';
      if(item.text === "Created:") {
        str += item.text+' '+data.created_at;
      }
      else if(item.text === "Updated:") {
        str += item.text+' '+data.updated_at;
      }
      else {
        str += item.text;
      }
      str += '</div>';
      return str;
    })
    $(container).html(logs.join(""));
  }

  //generate tech used
  PageProducts.prototype.generateTechUsed = function (container, data) {
    var tech = data.map(function (item) {
      var str ='<div class="tooltip-wrap">'
      str += '<div class="tooltip bs-tooltip-top" role="tooltip">'
      str += '<div class="arrow"></div>'
      str += '<div class="tooltip-inner">'+item.tooltip+'</div>'
      str += '</div>'
      str += '<span>'
      str += '<i class="bx '+item.icon+' text-'+item.iconClass+' h2 mb-0"></i>'
      str += '</span>'
      str += '</div>'
      return str
    })
    $(container).append(tech.join(""));
  }

  //generate theme detail html
  PageProducts.prototype.generateHTML = function (detail) {
    var self = this;
    if (detail && !detail.updateDate) {
      detail.updateDate = detail.createDate
    }
    window.currentPck = detail;
    window.currentPck.multiPrice = detail.price * 5;
    window.currentPck.multiple = false;
    $("#doc-btn").attr("href", detail.docLink);
    $("#slider-area").children("img").attr("sr.hc", "../assets/images/slider-screenshot"+detail.screenshot).attr("srcset", "../assets/images/slider-screenshot/"+ detail.smImg +" 766w, ../assets/images/slider-screenshot/"+detail.screenshot+" 3000w").attr("alt", detail.name); $("#single-use").html("<span>$</span>"+detail.price);
    $("#multi-use").html("<span>$</span>"+detail.price*5);
    if(!detail.free) {
      $("#free-purchase").remove();
      $("#payment-options").children().not("#free-purchase").removeClass("d-none");
    }
    else {
      $("#payment-options").children().not("#free-purchase").remove("d-none");
      $("#free-purchase").removeClass("d-none");
    }
    //techused
    this.generateTechUsed(".tech-details", detail.techUsed);
    //overview html
    document.getElementById("overview-html").innerHTML = detail.overviewHTML;
    //hightlights
    this.generateHighlights("#highlight1", detail.highlight1)
    this.generateHighlights("#highlight2", detail.highlight2)
    //themefacts html
    this.generateThemeFact(".theme-facts", detail.themeFacts);
    //demos html
    this.generateScreenshots("#demos", detail);
    //initial logs html
    this.generateInitialLog(".initial-logs", detail);
    this.runFn();
  }

  //generate related product html
  PageProducts.prototype.generateRelatedHTML = function (data) {
    if (data && data.length) {
      $("#related-products").html("");
      data.forEach(function (elem) {
        var str = '';
        var img = elem.screenshot.split(".")[0];
        var type = elem.screenshot.split(".")[1];
        var smImg = elem.screenshot ? img + '-sm.' + type : 'loading.jpg';
        var originalPrice = priceMapper[elem.id];
        str += '<div class="col-md-4">' +
          '<div class="demo-item" id="' + elem.id + '">' +
          '<a href="' + elem.detailLink + '" class="screenshot">' +
          '<img src="../assets/images/slider-screenshot/' + elem.screenshot + '" srcset="../assets/images/slider-screenshot/' + smImg + ' 766w, ../assets/images/slider-screenshot/' + elem.screenshot + ' 3000w" alt="' + elem.name + '" class="img-fluid w-100" width="714" height="456"/>' +
          '</a>' +
          '<div class="action-btn">' +
          '<a href="' + elem.detailLink + '#demos" title="Live Preview" class="btn btn-primary btn-sm">Live Preview</a>' +
          '</div>' +
          '<div class="theme-desc">' +
          '<div class="title">' +
          '<h3 class="h5"><a href="' + elem.detailLink + '" title="' + elem.name + '">' + elem.name + '</a></h3>' +
          '<p>' + elem.oneLinerDesc + '</p>' +
          '</div>' +
          '<div class="price">' +
          '<h4 class="font-weight-bold">$' + elem.price + '<span class="original-price">$' + originalPrice + '</span></h4>' +
          '<a class="category" href="' + elem.catLink + '">' + elem.mainCat + '</a>' +
          '</div>' +
          '</div>' +
          '</div>' +
          '</div>';
        var item = $.parseHTML(str);
        if (elem.category && elem.category.indexOf("angular") > -1) {
          $(item).find(".screenshot").append("<div class='icon'><i class='bx bxl-angular'></i></div>")
        }
        $("#related-products").append(item);
      });
    }
  }

  $.PageProducts = new PageProducts, $.PageProducts.Constructor = PageProducts
}(window.jQuery),
  function ($) {
    "use strict";
    $.PageProducts.init();
  }(window.jQuery);

