!function ($) {
  var PageProducts = function () {
  };

  //load razor pay after 5 seconds
  PageProducts.prototype.loadRazorpayScript = function () {
    setTimeout(function () {
      var script = document.createElement('script');
      script.src = "https://checkout.razorpay.com/v1/checkout.js";
      document.body.appendChild(script);
      $("#option-data #razorpay-btn").removeClass("disable-events");
    }, 1000)
  }

  //init funs
  PageProducts.prototype.init = function () {
    this.multi = false;
    this.appliedCouponCode = null;
    if (package_details) {
      this.product_details = package_details;
    }
    if (logged_user_details) {
      this.user_details = logged_user_details;
    }
    var params = new URLSearchParams(window.location.search);
    var success = params.get('success');
    if (success === 'true') {
      $("#successModal").modal('show');
      sendGAEvent("Downloaded", "Paypal", this.product_details.packageName+'- success');
    }
    else if (success === 'false') {
      $("#failureModal").modal('show');
      sendGAEvent("Downloaded", "Paypal", this.product_details.packageName+'- failure');
    }
    this.loadRazorpayScript();
    this.runFn();
  }

  //call after html loads
  PageProducts.prototype.runFn = function () {
    var self = this;

    // trigger review tab
    $("#see-review").click(function(){
      $("html, body").animate({
        scrollTop: $(".package-tabs").offset().top - 120
      }, 'slow');
      $("#review-tab").trigger('click')
    })

    // set multiple flag
    $("#licence-types li").on("click", function () {
      $(this).addClass("selected").siblings().removeClass("selected");
      var id = $(this).attr("data-tab");
      if (id === 'multiple') {
        self.multi = true
      }
      if (id === 'single') {
        self.multi = false
      }
      $("[data-id = " + id + "]").fadeIn().siblings().hide();
    })

    // change tabs
    $(".package-tabs .nav-link").on("click", function (e) {
      e.preventDefault();
      window.history.pushState({}, "", window.location.origin + window.location.pathname);
      var href = $(this).attr("href");
      $(href).addClass("show active").siblings().removeClass("show active");
      $(this).addClass("active").parent().siblings().find('.active').removeClass("active");
    })

    // preview btn click
    $("#preview-btn").on("click", function () {
      $("html, body").animate({
        scrollTop: $(".package-tabs").offset().top - 120
      }, 'slow');
      $("#demo-tab").trigger('click')
    })

    // navigate to demos
    if (location.hash === '#demos') {
      setTimeout(function () {
        $("#preview-btn").trigger('click')
      }, 100)
    }

    //hide bootstrap modal
    $('#successModal, #failureModal').on('hide.bs.modal', function () {
      window.history.pushState({}, "", window.location.origin + window.location.pathname);
    })

    //choose payment option
    $("#options .pay-btn").on('click', function () {
      var id = $(this).attr('data-selection');
      var payType = $(this).attr('data-type');
      $(this).addClass('selected').siblings().removeClass('selected');
      $("#option-data").find('[data-id=' + id + ']').addClass('active show').siblings().removeClass('active show');
    })

    //razorpay purchase event
    $("#razorpay-btn").on('click', function () {
      if (userAuthenticated.length) {
        $(this).addClass("disable-events");
        self.purchaseEvent()
      }
      else {
        $("#loginModal").modal('show');
      }
    })

    //paypal purchase event
    $("#paypal-btn").on("click", function () {
      if (userAuthenticated.length) {
        if ($.API) {
          var elem = this;
          var payload = {
            "coupan": self.appliedCouponCode,
            "product_id": self.product_details.productId,
            "multi": self.multi,
            "user_id": self.user_details.id
          }
          $(this).addClass("disable-events");
          var prom = $.API.post('payment/paypal', payload);
          prom.then(function (data) {
            if (data.status) {
              window.location.href = data.url;
              return;
            }
          }).catch(function (error) {
            $(elem).removeClass("disable-events");
            if (error && error.noToken) {
              $("#loginModal").modal('show');
              return;
            }
          }).finally(function () {
            $(elem).removeClass("disable-events");
          })
        }
      }
      else {
        $("#loginModal").modal('show');
      }
    });

    //free purchase event
    $("#free-purchase").on("click", function () {
      if (userAuthenticated.length) {
        if ($.API) {
          var elem = this;
          var payload = {
            "product_id": self.product_details.productId,
            "user_id": self.user_details.id
          }
          var elem = this;
          $(this).addClass("disable-events");
          var prom = $.API.post('payment/free', payload);
          prom.then(function (data) {
            if(data && data.code === 200 && data.hasOwnProperty('product_name')) {
              if(data.already_downloaded) {
                $("#alreadyDownloadedModal").modal('show');
                return;
              }
              self.downloadPackage();
              sendGAEvent("Downloaded", "Freebies", self.product_details.packageName+'- success');
            }
          }).catch(function (error) {
            if (error && error.noToken) {
              $("#loginModal").modal('show');
              return;
            }
            $("#failureModal").modal('show');
            sendGAEvent("Downloaded", "Freebies", self.product_details.packageName+'- failure');
          }).finally(function () {
            $(elem).removeClass("disable-events");
          })
        }
      }
      else {
        $("#loginModal").modal('show');
      }
    });

    //open coupon modal
    this.getCouponList();
    this.submitCouponForm();
  }


  //get coupon list
  PageProducts.prototype.getCouponList = function(){
    var self = this;
    if ($.API) {
      var prom = $.API.get('get-coupans');
      prom.then(function (data) {
        self.couponsHTML(data.coupans);
      })
    }
  }

  //create coupon HTML
  PageProducts.prototype.couponsHTML = function(coupons) {
    var self = this;
    coupons.forEach(function(item){
      var str = '<div class="coupon">';
      str += '<div class="coupon-text">';
      str += '<span class="code text-center">'+item.coupan_code+'</span>';
      str += '<div class="percent">Happy Independance Day <br/> '+item.discount_percent+'% off on all themes</div>';
      str += '</div>';
      str += '<button class="btn btn-outline-primary btn-sm" data-code="'+item.coupan_code+'">Apply</button>';
      str += '</div>';
      $("#coupon-list").append(str);
    })
    $(".coupon .btn").on("click", function(){
      var code = $(this).attr("data-code");
      self.checkCoupon(code);
      
    })
  }

  PageProducts.prototype.submitCouponForm = function(){
    var self = this;
    $("#checkCouponForm").on("submit", function(e){
      e.preventDefault();
      $("#coupon-apply-msg").addClass("d-none");
      var val = $(this).find(".form-control").val();
      if(val !== '' && val.length > 2){
        self.checkCoupon(val);
      }
    })
  }

  PageProducts.prototype.checkCoupon = function(code){
    if ($.API) {
      var self = this;
      var payload = {
        "coupan": code,
        "product_id": this.product_details.productId,
        "multi": this.multi
      }
      var prom = $.API.post('validate-coupan', payload);
      prom.then(function (data) {
        self.appliedCouponCode = code;
        $("#checkCouponForm")[0].reset();
        $("#coupon-apply-msg").removeClass("d-none");
        if(data.url !== "" || data.status) {
          $("#coupon-apply-msg").text("Coupon applied");
          $("#applyCouponModal").modal('hide');
          if(self.multi) {
            $("#multi-use").addClass('show-disc');
            $("#multi-use .disc").text('$'+data.amountPaid);
          }
          else {
            $("#single-use").addClass('show-disc');
            $("#single-use .disc").text('$'+data.amountPaid);
          }
        }
        else {
          $("#coupon-apply-msg").text("Coupon not valid");
        }
        setTimeout(function(){
          $("#coupon-apply-msg").removeClass("d-none");
        }, 5000)
      })
    }
  }

  //Razorpay buy now event
  PageProducts.prototype.purchaseEvent = function () {
    this.razorpayOrderCreate();
  }

  //Razorpay create order
  PageProducts.prototype.razorpayOrderCreate = function () {
    if ($.API) {
      var payload = {
        coupan: this.appliedCouponCode,
        product_id: this.product_details.productId,
        multi: this.multi
      }
      var self = this;
      $.API.post('razorpay/order/create', payload).then(function (resp) {
        if (resp) {
          var options = self.razorpayOption(resp.order_id);
          var rzpay = new Razorpay(options);
          rzpay.open();
          sendGAEvent("Order Create", "Razorpay", self.product_details.packageName);
          rzpay.on('payment.failed', function (response) {
            console.log("failed resp", response)
            throw response;
          });
        }
      }).catch(function (error) {
        sendGAEvent("Order Create Failed", "Razorpay", self.product_details.packageName);
        console.log("create order error ==>", error);
      }).finally(function () {
        $("#razorpay-btn").removeClass("disable-events");
      })
    }
  }

  //Razorpay verify order to save data on BE
  PageProducts.prototype.razorpayOrderVerify = function (response) {
    if ($.API) {
      var self = this;
      var payload = Object.assign(response, {
        product_id: this.product_details.productId,
        multi: this.multi,
        user_id: this.user_details.id
      })
      $("#razorpay-btn").addClass("disable-events");
      $.API.post('razorpay/order/verify', payload).then(function (resp) {
        if (resp && resp.code === 200 && resp.hasOwnProperty('product_name')) {
          self.downloadPackage()
          sendGAEvent("Downloaded", "Razorpay", self.product_details.packageName+'- success');
        }
        else {
          $("#failureModal").modal('show');
          sendGAEvent("Downloaded", "Razorpay", self.product_details.packageName+'- failure');
        }
      }).catch(function (error) {

      }).finally(function () {
        $("#razorpay-btn").removeClass("disable-events");
      })
    }
  }

  //download package after payment success
  PageProducts.prototype.downloadPackage = function () {
    $("#successModal").modal('show');
    if (userAuthenticated) {
      var userId = this.user_details.id;
      window.open(baseURL+"user/download-theme/" + this.product_details.productId + '/' + userId, '_blank');
      
    }
  }

  //get razorpay option
  PageProducts.prototype.razorpayOption = function (orderId) {
    var self = this;
    var obj = {}
    if (this.product_details) {
      obj['product_name'] = this.product_details.packageName;
      obj['amount'] = this.multi ? (this.product_details.price * 5) : this.product_details.price;
    }
    if (userAuthenticated) {
      obj["email_address"] = this.user_details.email;
    }
    return {
      name: "Lettstart Design",
      description: this.product_details.packageName,
      image: "https://lettstartdesign.com/assets/images/logo-dark.png",
      "order_id": orderId,
      "handler": function (response) {
        self.razorpayOrderVerify(response)
      },
      "notes": obj,
      "theme": {
        "color": "#2982de"
      }
    }
  }

  $.PageProducts = new PageProducts, $.PageProducts.Constructor = PageProducts
}(window.jQuery),
  function ($) {
    "use strict";
    $.PageProducts.init();
  }(window.jQuery);


function sendGAEvent(eventCategory, eventAction, eventLabel) {
  ga('send', 'event', {
    eventCategory: eventCategory,
    eventAction: eventAction,
    eventLabel: eventLabel
  });
}
